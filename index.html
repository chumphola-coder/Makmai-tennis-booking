<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Makmai Tennis Club - Cloud System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Flatpickr for custom date format -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Add Flatpickr Thai Locale -->
    <script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script>
    <!-- Add Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .glass-panel { background: #ffffff; border-radius: 1rem; box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.05); }
        .table-scroll { max-height: 450px; overflow-y: auto; }
        
        /* Flatpickr Customization */
        .flatpickr-calendar { font-family: 'Kanit', sans-serif; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: none; }
        .flatpickr-day.selected { background: #2563eb !important; border-color: #2563eb !important; }
        
        /* Print Styles - Fixed for Receipt */
        @media print {
            body * {
                visibility: hidden;
            }
            #receiptModal, #receiptModal * {
                visibility: visible;
            }
            #receiptModal {
                position: fixed;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                background: white !important;
                display: block !important;
                z-index: 9999;
                overflow: visible !important;
            }
            #receiptContent {
                width: 100%;
                margin: 0;
                padding: 20px;
            }
            .no-print {
                display: none !important;
            }
            /* Hide close/print buttons inside modal during print */
            #receiptActions {
                display: none !important;
            }
        }

        .modal-active { display: flex !important; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        #customAlert { display: none; position: fixed; top: 20px; right: 20px; z-index: 9999; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .slot-free { background-color: #ecfdf5; color: #065f46; }
        /* Changed slot-booked from yellow to orange for 'Pending' */
        .slot-booked { background-color: #ffedd5; color: #c2410c; }
        /* Changed slot-paid from red to blue for 'Paid' */
        .slot-paid { background-color: #dbeafe; color: #1e40af; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="customAlert" class="bg-red-600 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
        <span id="alertMessage" class="font-bold"></span>
    </div>

    <!-- Hidden Input for Updating Slip -->
    <input type="file" id="updateSlipInput" class="hidden" accept="image/*">

    <div class="max-w-[1400px] mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 no-print">
            <div>
                <h1 class="text-3xl font-black text-slate-800 tracking-tight flex items-center gap-2">
                    <span class="bg-blue-600 text-white p-1 rounded">üéæ</span> ‡πÅ‡∏°‡∏Å‡πÑ‡∏°‡πâ‡πÄ‡∏ó‡∏ô‡∏ô‡∏¥‡∏™‡∏Ñ‡∏•‡∏±‡∏ö
                </h1>
                <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mt-1">Internet Database</p>
            </div>
            <div class="flex gap-2">
                <button onclick="openReportModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm font-bold hover:bg-indigo-700 flex items-center gap-2 transition-all shadow-lg shadow-indigo-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Left: Form -->
            <div class="lg:col-span-4 no-print">
                <div class="glass-panel p-6 border border-slate-200 sticky top-4" id="bookingPanel">
                    <h2 class="text-xl font-bold text-slate-700 mb-4">‡∏à‡∏≠‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏ï‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏ó‡∏ô‡∏ô‡∏¥‡∏™</h2>
                    <form id="bookingForm" class="space-y-4">
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-500 uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                    <!-- Use text input for Flatpickr -->
                                    <input type="text" id="dateInput" name="date" required class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white cursor-pointer" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-500 uppercase">‡∏™‡∏ô‡∏≤‡∏°</label>
                                    <select name="court" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                        <option value="‡∏™‡∏ô‡∏≤‡∏° 1">‡∏™‡∏ô‡∏≤‡∏° 1</option>
                                        <option value="‡∏™‡∏ô‡∏≤‡∏° 2">‡∏™‡∏ô‡∏≤‡∏° 2</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase">‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                                    <select name="time" id="timeSelect" onchange="updateHourOptions()" class="w-full border border-slate-200 rounded-lg px-2 py-2 text-sm"></select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase">‡∏ä‡∏°.</label>
                                    <select name="hours" id="hoursSelect" onchange="updateLightHoursOptions()" class="w-full border border-slate-200 rounded-lg px-2 py-2 text-sm font-bold text-blue-600"></select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase">‡πÑ‡∏ü</label>
                                    <select name="lightHours" id="lightHoursSelect" onchange="calculateTotal()" class="w-full border border-slate-200 rounded-lg px-2 py-2 text-sm font-bold text-amber-600"></select>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <!-- Changed style to match other labels -->
                                <span class="text-xs font-bold text-slate-500 uppercase">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</span>
                                <select id="customerHistory" onchange="fillCustomerInfo(this.value)" class="text-xs text-blue-600 font-bold bg-transparent outline-none cursor-pointer">
                                    <option value="">‚ñº ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="inputName" name="customerName" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                <input type="tel" id="inputPhone" name="phoneNumber" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm">
                            </div>
                            
                            <div class="flex items-center gap-2 w-full">
                                <div class="flex items-center shrink-0">
                                    <span class="text-sm text-slate-400 mr-1">125/</span>
                                    <input type="text" id="inputAddress" name="address" required placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" class="w-16 border border-slate-200 rounded-lg px-2 py-2 text-sm text-center">
                                </div>
                                <div class="flex-1 min-w-0">
                                    <input type="text" id="inputOwner" name="ownerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm truncate">
                                </div>
                            </div>
                            
                            <!-- Custom File Upload Button -->
                            <div class="relative group">
                                <input type="file" id="slipInput" accept="image/*" class="hidden" onchange="updateFileName(this)">
                                <label for="slipInput" class="flex items-center justify-center gap-2 w-full px-4 py-2.5 bg-slate-100 text-slate-500 rounded-xl cursor-pointer hover:bg-slate-200 border border-slate-200 text-sm transition-all group-hover:border-blue-300 group-hover:text-blue-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                    <span id="slipFileName">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</span>
                                </label>
                            </div>
                        </div>

                        <div class="p-4 bg-slate-50 rounded-2xl flex justify-between items-center border-2 border-dashed border-blue-100">
                            <span class="text-xs font-bold text-slate-400 uppercase">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
                            <span id="totalPriceDisplay" class="text-2xl font-black text-blue-700">‡∏ø0</span>
                        </div>

                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-2xl shadow-lg transition-transform active:scale-95">
                            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                        </button>
                    </form>
                </div>
            </div>

            <!-- Right: Content -->
            <div class="lg:col-span-8 space-y-6">
                <!-- 1. Booking List -->
                <div class="glass-panel border border-slate-200 overflow-hidden no-print">
                    <div class="p-4 bg-white border-b flex justify-between items-center gap-4">
                        <h3 class="font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3>
                        <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-lg">
                            <button onclick="navigateWeek(-1)" class="p-1 hover:bg-white rounded transition-colors" title="‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            </button>
                            <div id="weekDisplay" class="text-xs font-bold text-slate-600 w-36 text-center select-none cursor-default">
                                Loading...
                            </div>
                            <button onclick="navigateWeek(1)" class="p-1 hover:bg-white rounded transition-colors" title="‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            </button>
                            <button onclick="goToCurrentWeek()" class="px-3 py-1 bg-white text-blue-600 rounded text-[10px] font-black uppercase hover:bg-blue-600 hover:text-white transition-all shadow-sm">
                                ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ
                            </button>
                        </div>
                    </div>
                    <div class="table-scroll">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 sticky top-0 text-[10px] uppercase font-bold text-slate-400">
                                <tr>
                                    <th class="px-4 py-3">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="px-4 py-3">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏ö‡πâ‡∏≤‡∏ô</th>
                                    <th class="px-4 py-3">‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤ / ‡∏™‡∏ô‡∏≤‡∏°</th>
                                    <th class="px-4 py-3 text-right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                                    <th class="px-4 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="bookingTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- 2. Visual Schedule -->
                <div class="glass-panel p-5 border border-slate-200">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                        <div class="flex items-center gap-3">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2">
                                <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"></path></svg>
                                ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ô‡∏≤‡∏°
                            </h3>
                            <!-- Use text input for Flatpickr -->
                            <input type="text" id="scheduleDateInput" class="bg-slate-50 border border-slate-200 rounded-lg px-2 py-1 text-xs font-bold text-slate-600 outline-none focus:ring-1 focus:ring-blue-500 w-32 text-center" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">
                        </div>
                        <div class="flex gap-4 text-[10px] font-bold uppercase tracking-wider">
                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-emerald-400"></span> ‡∏ß‡πà‡∏≤‡∏á</span>
                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-orange-400"></span> ‡∏à‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</span>
                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-blue-500"></span> ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-center border-collapse">
                            <thead>
                                <tr class="bg-slate-50 text-[11px] font-black text-slate-400 uppercase">
                                    <th class="p-2 border-b w-20">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                    <th class="p-2 border-b">‡∏™‡∏ô‡∏≤‡∏° 1</th>
                                    <th class="p-2 border-b">‡∏™‡∏ô‡∏≤‡∏° 2</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleGridBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="receiptModal" class="fixed inset-0 bg-slate-900/90 z-50 hidden items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white max-w-[210mm] w-full shadow-2xl relative flex flex-col items-center p-8">
            <button onclick="closeModal()" class="no-print absolute top-4 right-4 text-slate-400 hover:text-red-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div id="receiptContent" class="w-full space-y-12"></div>
            <!-- Receipt Actions with Close Button -->
            <div id="receiptActions" class="no-print mt-8 flex gap-3">
                <button onclick="closeModal()" class="px-6 py-3 bg-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-300 transition-colors">‡∏õ‡∏¥‡∏î</button>
                <button onclick="window.print()" class="px-10 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-colors">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (A4)</button>
            </div>
        </div>
    </div>

    <div id="reportModal" class="fixed inset-0 bg-slate-900/90 z-50 hidden items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-3xl max-w-4xl w-full p-8 relative">
            <button onclick="closeModal()" class="no-print absolute top-6 right-6 text-slate-400 z-10"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <div id="reportSummaryContent" class="space-y-6"></div>
        </div>
    </div>

    <div id="slipModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4">
        <div class="max-w-lg w-full relative">
            <button onclick="closeModal()" class="absolute -top-10 right-0 text-white"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <img id="slipPreview" src="" class="w-full rounded-xl">
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- Firebase Config & App ID Setup ---
        const rawConfig = window.__firebase_config || (typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const firebaseConfig = JSON.parse(rawConfig);
        
        const rawAppId = window.__app_id || (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');
        const appId = rawAppId;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentFilterWeek = '';
        let currentUploadId = null;
        let revenueChart = null;
        let housesChart = null;
        let allBookingsCache = [];
        
        window.slipCache = {};

        const initAuth = async () => {
            try {
                const token = window.__initial_auth_token || (typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null);
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                window.showAlert("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä");
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                init();
            } else {
                currentUser = null;
            }
        });

        initAuth();

        const getBookingsRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'bookings');
        const getCustomersRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'customers');

        function getThailandDate() {
            // Get current time in Thailand (UTC+7)
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const thailandTime = new Date(utc + (7 * 3600000));
            return thailandTime.toISOString().split('T')[0];
        }

        function init() {
            const dateStr = getThailandDate();
            
            // Initialize Flatpickr for Booking Form
            flatpickr("#dateInput", {
                locale: 'th',
                altInput: true,
                altFormat: "d/M/Y",
                dateFormat: "Y-m-d", 
                minDate: dateStr,
                defaultDate: dateStr,
                onChange: function(selectedDates, dateStr, instance) {
                    syncDateToSchedule();
                }
            });
            
            // Initialize Flatpickr for Schedule View
            flatpickr("#scheduleDateInput", {
                locale: 'th',
                altInput: true,
                altFormat: "d/M/Y",
                dateFormat: "Y-m-d",
                defaultDate: dateStr,
                onChange: function(selectedDates, dateStr, instance) {
                    renderSchedule();
                }
            });
            
            const timeSelect = document.getElementById('timeSelect');
            if (timeSelect) {
                let timeHtml = '';
                for(let i=7; i<=21; i++) {
                    const val = `${String(i).padStart(2,'0')}:00`;
                    timeHtml += `<option value="${val}">${i}:00 ‡∏ô.</option>`;
                }
                timeSelect.innerHTML = timeHtml;
            }
            
            updateHourOptions();
            goToCurrentWeek();
            loadCustomerHistory();
        }

        window.updateHourOptions = () => {
            const timeSelect = document.getElementById('timeSelect');
            if (!timeSelect) return;
            const start = parseInt(timeSelect.value);
            const max = 22 - start; 
            let html = '';
            for(let i=1; i<=Math.min(4, max); i++) html += `<option value="${i}">${i}</option>`;
            const hoursSelect = document.getElementById('hoursSelect');
            if (hoursSelect) hoursSelect.innerHTML = html;
            window.updateLightHoursOptions();
        }

        window.updateLightHoursOptions = () => {
            const hoursSelect = document.getElementById('hoursSelect');
            if (!hoursSelect) return;
            const hrs = parseInt(hoursSelect.value);
            let html = '<option value="0">‡∏õ‡∏¥‡∏î</option>';
            for(let i=1; i<=hrs; i++) html += `<option value="${i}">${i} ‡∏ä‡∏°.</option>`;
            const lightHoursSelect = document.getElementById('lightHoursSelect');
            if (lightHoursSelect) lightHoursSelect.innerHTML = html;
            window.calculateTotal();
        }

        window.calculateTotal = () => {
            const hoursSelect = document.getElementById('hoursSelect');
            const lightHoursSelect = document.getElementById('lightHoursSelect');
            
            const h = hoursSelect ? (parseInt(hoursSelect.value) || 0) : 0;
            const l = lightHoursSelect ? (parseInt(lightHoursSelect.value) || 0) : 0;
            const total = (h * 150) + (l * 50);
            
            const display = document.getElementById('totalPriceDisplay');
            if (display) display.innerText = `‡∏ø${total.toLocaleString()}`;
        }

        window.updateFileName = (input) => {
            const span = document.getElementById('slipFileName');
            if (input.files && input.files[0]) {
                span.innerText = input.files[0].name;
                span.classList.add('text-blue-600', 'font-bold');
            } else {
                span.innerText = '‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô';
                span.classList.remove('text-blue-600', 'font-bold');
            }
        }

        window.selectSlot = (dateStr, timeStr, courtName) => {
            // 1. Check if past date/time (simple check for today)
            const now = new Date();
            const todayStr = getThailandDate();
            
            if (dateStr < todayStr) {
                window.showAlert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ");
                return;
            }
            
            // 2. Update Date
            const dateInput = document.getElementById('dateInput');
            if (dateInput && dateInput._flatpickr) {
                dateInput._flatpickr.setDate(dateStr);
            }
            
            // 3. Update Court
            const courtSelect = document.querySelector('select[name="court"]');
            if (courtSelect) {
                courtSelect.value = courtName;
            }

            // 4. Update Time
            const timeSelect = document.getElementById('timeSelect');
            if (timeSelect) {
                timeSelect.value = timeStr;
                updateHourOptions();
            }

            // 5. Scroll to Booking Form
            const panel = document.getElementById('bookingPanel');
            if(panel) {
                panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Optional: Flash effect
                panel.classList.add('ring-2', 'ring-blue-500');
                setTimeout(() => panel.classList.remove('ring-2', 'ring-blue-500'), 1000);
            }
        }

        window.syncDateToSchedule = () => {
            const dateInput = document.getElementById('dateInput');
            const scheduleInput = document.getElementById('scheduleDateInput');
            
            if (!dateInput || !scheduleInput) return;
            
            const formDate = dateInput.value; 
            
            if(scheduleInput._flatpickr) {
                scheduleInput._flatpickr.setDate(formDate);
            }
            
            const newWeek = getWeekString(formDate);
            if (newWeek !== currentFilterWeek) {
                currentFilterWeek = newWeek;
                updateWeekDisplay();
            }
            renderAll();
        }

        function getWeekString(date) {
            const d = new Date(date);
            d.setHours(0,0,0,0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const year = d.getFullYear();
            const week = Math.ceil((((d - new Date(year, 0, 1)) / 86400000) + 1) / 7);
            return `${year}-W${String(week).padStart(2, '0')}`;
        }

        function getStartOfWeek(weekStr) {
             const [y, w] = weekStr.split('-W').map(Number);
             const d = new Date(y, 0, 4); 
             const day = d.getDay() || 7;
             d.setDate(d.getDate() - day + 1 + ((w - 1) * 7));
             return d;
        }

        function updateWeekDisplay() {
            const display = document.getElementById('weekDisplay');
            if (!currentFilterWeek || !display) return;
            const d = getStartOfWeek(currentFilterWeek);
            const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
            const formatted = `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
            display.innerText = `‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏µ‡πà: ${formatted}`;
        }

        window.goToCurrentWeek = () => {
            const dateStr = getThailandDate();
            currentFilterWeek = getWeekString(dateStr);
            updateWeekDisplay();
            const input = document.getElementById('scheduleDateInput');
            if (input && input._flatpickr) input._flatpickr.setDate(dateStr);
            renderAll();
        }

        window.navigateWeek = (dir) => {
            const d = getStartOfWeek(currentFilterWeek);
            d.setDate(d.getDate() + (dir * 7));
            currentFilterWeek = getWeekString(d);
            updateWeekDisplay();
            const dateStr = d.toISOString().split('T')[0];
            const input = document.getElementById('scheduleDateInput');
            if (input && input._flatpickr) input._flatpickr.setDate(dateStr);
            renderAll();
        }

        window.handleWeekChange = (v) => {
            currentFilterWeek = v;
            const [y, w] = v.split('-W').map(Number);
            let d = new Date(y, 0, 1 + (w - 1) * 7);
            d.setDate(d.getDate() - (d.getDay() || 7) + 1);
            const dateStr = d.toISOString().split('T')[0];
            const input = document.getElementById('scheduleDateInput');
            if (input && input._flatpickr) input._flatpickr.setDate(dateStr);
            updateWeekDisplay();
            renderAll();
        }

        function renderAll() {
            renderBookingList();
            renderSchedule();
        }

        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 800;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        };

        function generateRef(b) {
            const [y, m, d] = b.date.split('-');
            const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
            const monthName = months[parseInt(m) - 1];
            const shortYear = y.slice(-2);
            
            const courtCode = b.court.includes('1') ? 'C-1' : (b.court.includes('2') ? 'C-2' : 'C-?');
            
            const start = parseInt(b.time);
            const end = start + b.hours;
            
            return `${courtCode}/${start}-${end}/${d}-${monthName}-${shortYear}`;
        }

        function formatDate(dateStr) {
            const [y, m, d] = dateStr.split('-');
            const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
            return `${d}/${months[parseInt(m) - 1]}/${y}`;
        }

        window.triggerUploadSlip = (id) => {
            currentUploadId = id;
            document.getElementById('updateSlipInput').click();
        }

        document.getElementById('updateSlipInput').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file || !currentUploadId) return;

            try {
                const slipBase64 = await compressImage(file);
                const bookingRef = doc(db, 'artifacts', appId, 'public', 'data', 'bookings', currentUploadId);
                await updateDoc(bookingRef, { slip: slipBase64 });
                window.showAlert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                renderAll(); 
            } catch (err) {
                console.error("Update Slip Error:", err);
                window.showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
            } finally {
                e.target.value = '';
                currentUploadId = null;
            }
        }

        document.getElementById('bookingForm').onsubmit = async (e) => {
            e.preventDefault();
            if (!currentUser) {
                window.showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...");
                return;
            }

            const fd = new FormData(e.target);
            const date = fd.get('date');
            const court = fd.get('court');
            const startTime = fd.get('time');
            const hours = parseInt(fd.get('hours'));
            
            const startHour = parseInt(startTime.split(':')[0]);
            const requestedSlots = [];
            for(let i=0; i<hours; i++) requestedSlots.push(startHour + i);

            try {
                const snapshot = await getDocs(getBookingsRef());
                const bookings = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));

                const existing = bookings.filter(b => b.date === date && b.court === court);
                const isConflict = existing.some(b => {
                    const bStart = parseInt(b.time.split(':')[0]);
                    const bEnd = bStart + b.hours;
                    return requestedSlots.some(s => s >= bStart && s < bEnd);
                });

                if (isConflict) {
                    showAlert("‡∏™‡∏ô‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß!");
                    return;
                }
                saveBooking(fd);
            } catch (err) {
                console.error("Save Error:", err);
                showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            }
        };

        async function saveBooking(fd) {
            const file = document.getElementById('slipInput').files[0];
            let slipBase64 = null;
            if (file) {
                try {
                    slipBase64 = await compressImage(file);
                } catch (e) {
                    console.error("Image compression error", e);
                }
            }

            const data = {
                date: fd.get('date'),
                court: fd.get('court'),
                time: fd.get('time'),
                hours: parseInt(fd.get('hours')),
                lightHours: parseInt(fd.get('lightHours')),
                customerName: fd.get('customerName'),
                phoneNumber: fd.get('phoneNumber'),
                address: fd.get('address'),
                ownerName: fd.get('ownerName'),
                totalPrice: (parseInt(fd.get('hours')) * 150) + (parseInt(fd.get('lightHours')) * 50),
                slip: slipBase64,
                timestamp: Date.now(),
                week: getWeekString(fd.get('date'))
            };

            await addDoc(getBookingsRef(), data);

            const custData = {
                name: data.customerName,
                phone: data.phoneNumber,
                address: data.address,
                owner: data.ownerName
            };
            
            try {
                await addDoc(getCustomersRef(), custData);
            } catch (err) {
                console.log("Error saving customer (minor)", err);
            }

            const currentCourt = fd.get('court');
            const currentDate = fd.get('date');
            document.getElementById('bookingForm').reset();
            
            // Reset File Input Display
            const slipSpan = document.getElementById('slipFileName');
            if(slipSpan) {
                slipSpan.innerText = '‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô';
                slipSpan.classList.remove('text-blue-600', 'font-bold');
            }
            
            document.getElementById('dateInput')._flatpickr.setDate(currentDate);
            document.getElementsByName('court')[0].value = currentCourt;
            
            renderAll();
            loadCustomerHistory();
        }

        window.renderSchedule = async () => {
            if (!currentUser) return;
            const input = document.getElementById('scheduleDateInput');
            if (!input) return;
            
            const selectedDate = input.value;
            const tbody = document.getElementById('scheduleGridBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            try {
                const snapshot = await getDocs(getBookingsRef());
                const bookings = snapshot.docs
                    .map(doc => ({ ...doc.data(), id: doc.id }))
                    .filter(b => b.date === selectedDate);

                for(let h=7; h<=21; h++) {
                    const timeStr = `${String(h).padStart(2,'0')}:00`;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="p-2 border-b font-mono text-slate-400">${timeStr}</td>`;
                    
                    ["‡∏™‡∏ô‡∏≤‡∏° 1", "‡∏™‡∏ô‡∏≤‡∏° 2"].forEach(court => {
                        const booking = bookings.find(b => {
                            const bStart = parseInt(b.time.split(':')[0]);
                            return b.court === court && h >= bStart && h < (bStart + b.hours);
                        });
                        
                        const td = document.createElement('td');
                        td.className = "p-1 border border-slate-100 transition-colors";
                        if(booking) {
                            td.innerHTML = `<div class="rounded py-1 text-[10px] font-bold ${booking.slip ? 'slot-paid' : 'slot-booked'}">${booking.customerName}</div>`;
                        } else {
                            // Added onclick handler to select slot
                            td.innerHTML = `<div onclick="selectSlot('${selectedDate}', '${timeStr}', '${court}')" class="rounded py-1 text-[10px] font-medium slot-free cursor-pointer hover:bg-emerald-200 transition-colors">‡∏ß‡πà‡∏≤‡∏á</div>`;
                        }
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                }
            } catch (err) {
                console.error("Render Schedule Error:", err);
            }
        }

        async function renderBookingList() {
            if (!currentUser) return;
            const tbody = document.getElementById('bookingTableBody');
            if (!tbody) return;
            tbody.innerHTML = ''; 
            
            window.slipCache = {};

            try {
                const snapshot = await getDocs(getBookingsRef());
                const list = snapshot.docs
                    .map(doc => ({ ...doc.data(), id: doc.id }))
                    .filter(b => b.week === currentFilterWeek)
                    .sort((a,b) => b.timestamp - a.timestamp);

                if (list.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-8 text-center text-slate-400 font-medium">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</td></tr>`;
                    return;
                }

                list.forEach(b => {
                    if (b.slip) {
                        window.slipCache[b.id] = b.slip;
                    }
                    
                    const refCode = generateRef(b);

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition-colors";
                    tr.innerHTML = `
                        <td class="px-4 py-3">
                            <div class="text-[10px] font-bold text-slate-400 font-mono tracking-tight">${refCode}</div>
                            <span class="px-2 py-0.5 rounded-full text-[10px] font-black ${b.slip ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'}">
                                ${b.slip ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞'}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="font-bold text-slate-700">${b.customerName}</div>
                            <div class="text-[11px] text-slate-400">125/${b.address}</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="font-bold text-blue-600">${formatDate(b.date)}</div>
                            <div class="text-[11px] font-bold text-slate-500">${b.time} (${b.hours} ‡∏ä‡∏°.) - ${b.court}</div>
                        </td>
                        <td class="px-4 py-3 text-right font-black text-slate-700">‡∏ø${b.totalPrice.toLocaleString()}</td>
                        <td class="px-4 py-3">
                            <div class="flex justify-center gap-1">
                                <button onclick="printReceipt('${b.id}')" class="p-2 hover:bg-blue-50 text-blue-600 rounded-lg" title="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg></button>
                                ${!b.slip ? 
                                `<button onclick="triggerUploadSlip('${b.id}')" class="p-2 hover:bg-slate-100 text-slate-400 hover:text-blue-600 rounded-lg" title="‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                 </button>` :
                                `<button onclick="viewSlipFromId('${b.id}')" class="p-2 hover:bg-emerald-50 text-emerald-600 rounded-lg" title="‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                 </button>`
                                }
                                <button onclick="deleteBooking('${b.id}')" class="p-2 hover:bg-red-50 text-red-500 rounded-lg" title="‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error("Render List Error:", err);
            }
        }

        async function loadCustomerHistory() {
            if (!currentUser) return;
            const s = document.getElementById('customerHistory');
            
            try {
                const snapshot = await getDocs(getCustomersRef());
                if (s) {
                    s.innerHTML = '<option value="">‚ñº ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°</option>';
                    
                    const uniqueCustomers = new Map();
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (!uniqueCustomers.has(data.name)) {
                            uniqueCustomers.set(data.name, data);
                        }
                    });

                    uniqueCustomers.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = JSON.stringify(c);
                        opt.textContent = c.name;
                        s.appendChild(opt);
                    });
                }
            } catch (err) {
                console.error("Load Customers Error:", err);
            }
        }

        window.fillCustomerInfo = (json) => {
            if(!json) return;
            const c = JSON.parse(json);
            document.getElementById('inputName').value = c.name;
            document.getElementById('inputPhone').value = c.phone || '';
            document.getElementById('inputAddress').value = c.address || '';
            document.getElementById('inputOwner').value = c.owner || '';
        }

        window.openReportModal = async () => {
            if (!currentUser) return;
            
            try {
                const snapshot = await getDocs(getBookingsRef());
                const list = snapshot.docs.map(d => d.data());
                allBookingsCache = list;
                
                const now = new Date();
                const curMonth = now.getMonth();
                const curYear = now.getFullYear();

                const monthTotal = list.filter(b => {
                    const d = new Date(b.date);
                    return d.getMonth() === curMonth && d.getFullYear() === curYear;
                }).reduce((sum, b) => sum + b.totalPrice, 0);

                const yearTotal = list.filter(b => {
                    const d = new Date(b.date);
                    return d.getFullYear() === curYear;
                }).reduce((sum, b) => sum + b.totalPrice, 0);

                const content = document.getElementById('reportSummaryContent');
                content.innerHTML = `
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-black text-slate-800">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Analytics)</h2>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mt-1">Makmai Tennis Club</p>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-50 p-6 rounded-2xl text-center border border-blue-100">
                            <div class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-1">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                            <div class="text-3xl font-black text-blue-700">‡∏ø${monthTotal.toLocaleString()}</div>
                        </div>
                        <div class="bg-indigo-50 p-6 rounded-2xl text-center border border-indigo-100">
                            <div class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-1">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏õ‡∏µ‡∏ô‡∏µ‡πâ (${curYear})</div>
                            <div class="text-3xl font-black text-indigo-700">‡∏ø${yearTotal.toLocaleString()}</div>
                        </div>
                    </div>

                    <!-- Charts Area -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                            <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 text-center">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏õ‡∏µ ${curYear})</h3>
                            <canvas id="revenueChart"></canvas>
                        </div>
                        <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                            <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 text-center">5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏≠‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
                            <canvas id="housesChart"></canvas>
                        </div>
                    </div>

                    <!-- Export Section -->
                    <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                        <h3 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="text" id="exportStartDate" class="w-full mt-1 border border-slate-300 rounded-lg px-3 py-2 text-xs">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="text" id="exportEndDate" class="w-full mt-1 border border-slate-300 rounded-lg px-3 py-2 text-xs">
                            </div>
                            <div class="flex items-end gap-2">
                                <button onclick="exportToCSV()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg text-sm transition-colors shadow-md">
                                    .CSV
                                </button>
                                <button onclick="exportToXLSX()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded-lg text-sm transition-colors shadow-md">
                                    .XLSX
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="pt-6 no-print grid grid-cols-2 gap-4">
                        <button onclick="closeModal()" class="w-full bg-slate-200 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-300 transition-colors">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
                        <button onclick="window.print()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition-colors">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</button>
                    </div>
                `;
                
                document.getElementById('reportModal').classList.add('modal-active');
                
                // Initialize Flatpickr for Export
                flatpickr("#exportStartDate", { 
                    locale: 'th',
                    dateFormat: "Y-m-d", 
                    altInput: true,
                    altFormat: "d/M/Y",
                    defaultDate: new Date(curYear, curMonth, 1) 
                });
                flatpickr("#exportEndDate", { 
                    locale: 'th',
                    dateFormat: "Y-m-d", 
                    altInput: true,
                    altFormat: "d/M/Y",
                    defaultDate: new Date(curYear, curMonth + 1, 0) 
                });

                // Render Charts
                renderCharts(list, curYear);

            } catch (err) {
                console.error("Report Error:", err);
            }
        }

        window.renderCharts = (bookings, year) => {
            // 1. Monthly Revenue Data
            const monthlyRevenue = new Array(12).fill(0);
            bookings.forEach(b => {
                const d = new Date(b.date);
                if(d.getFullYear() === year) {
                    monthlyRevenue[d.getMonth()] += b.totalPrice;
                }
            });

            // 2. Top 5 Houses Data
            const houseCounts = {};
            bookings.forEach(b => {
                const addr = b.address ? `125/${b.address}` : 'Unknown';
                houseCounts[addr] = (houseCounts[addr] || 0) + 1;
            });
            const sortedHouses = Object.entries(houseCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            // Destroy existing charts if any
            if(revenueChart) revenueChart.destroy();
            if(housesChart) housesChart.destroy();

            // Create Revenue Chart
            const ctxRev = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(ctxRev, {
                type: 'bar',
                data: {
                    labels: ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'],
                    datasets: [{
                        label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)',
                        data: monthlyRevenue,
                        backgroundColor: '#4f46e5',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Create Houses Chart
            const ctxHouse = document.getElementById('housesChart').getContext('2d');
            housesChart = new Chart(ctxHouse, {
                type: 'doughnut',
                data: {
                    labels: sortedHouses.map(([h]) => h),
                    datasets: [{
                        data: sortedHouses.map(([,c]) => c),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } }
                }
            });
        }

        window.exportToCSV = () => {
            const startStr = document.getElementById('exportStartDate').value;
            const endStr = document.getElementById('exportEndDate').value;
            
            if(!startStr || !endStr) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");
                return;
            }

            const start = new Date(startStr);
            const end = new Date(endStr);
            end.setHours(23, 59, 59);

            const filtered = allBookingsCache.filter(b => {
                const d = new Date(b.date);
                return d >= start && d <= end;
            }).sort((a,b) => new Date(a.date) - new Date(b.date));

            // BOM for Excel to read UTF-8 correctly
            let csvContent = "\uFEFF"; 
            csvContent += "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏ß‡∏•‡∏≤,‡∏™‡∏ô‡∏≤‡∏°,‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á,‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£,‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà,‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á,‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á,‡πÑ‡∏ü(‡∏ä‡∏°.),‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\n";

            filtered.forEach(b => {
                const status = b.slip ? "‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß" : "‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞";
                const row = [
                    `"${b.date}"`,
                    `"${b.time}"`,
                    `"${b.court}"`,
                    `"${b.customerName || ''}"`,
                    `"${b.phoneNumber || ''}"`,
                    `"125/${b.address || ''}"`,
                    `"${b.ownerName || ''}"`,
                    b.hours,
                    b.lightHours,
                    b.totalPrice,
                    status
                ].join(",");
                csvContent += row + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `makmai_report_${startStr}_to_${endStr}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.exportToXLSX = () => {
            const startStr = document.getElementById('exportStartDate').value;
            const endStr = document.getElementById('exportEndDate').value;
            
            if(!startStr || !endStr) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");
                return;
            }

            const start = new Date(startStr);
            const end = new Date(endStr);
            end.setHours(23, 59, 59);

            const filtered = allBookingsCache.filter(b => {
                const d = new Date(b.date);
                return d >= start && d <= end;
            }).sort((a,b) => new Date(a.date) - new Date(b.date));

            const data = filtered.map(b => ({
                "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà": b.date,
                "‡πÄ‡∏ß‡∏•‡∏≤": b.time,
                "‡∏™‡∏ô‡∏≤‡∏°": b.court,
                "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á": b.customerName || '',
                "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£": b.phoneNumber || '',
                "‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà": `125/${b.address || ''}`,
                "‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á": b.ownerName || '',
                "‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á": b.hours,
                "‡πÑ‡∏ü(‡∏ä‡∏°.)": b.lightHours,
                "‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô": b.totalPrice,
                "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞": b.slip ? "‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß" : "‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞"
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Bookings");
            XLSX.writeFile(wb, `makmai_report_${startStr}_to_${endStr}.xlsx`);
        }

        window.printReceipt = async (id) => {
            if (!currentUser) return;
            
            try {
                const snapshot = await getDocs(getBookingsRef());
                const b = snapshot.docs.find(d => d.id === id)?.data();

                if (!b) return;

                const container = document.getElementById('receiptContent');
                container.innerHTML = '';
                
                const refCode = generateRef(b);
                
                const receiptHtml = () => `
                    <div class="space-y-6 text-slate-800">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-2xl font-black">MAKMAI TENNIS CLUB</h2>
                                <p class="text-xs uppercase tracking-widest font-bold text-slate-400">Official Payment Receipt</p>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] font-bold text-slate-400 uppercase">Receipt No.</div>
                                <div class="text-lg font-mono font-bold text-blue-600">#${refCode}</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-8 border-y py-6 border-slate-100">
                            <div>
                                <div class="text-[10px] font-black text-slate-400 uppercase mb-2">‡∏à‡∏≠‡∏á‡πÇ‡∏î‡∏¢ (Customer)</div>
                                <div class="text-lg font-bold">${b.customerName}</div>
                                <div class="text-sm text-slate-500">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 125/${b.address} ${b.ownerName ? `(${b.ownerName})` : ''}</div>
                                <div class="text-sm text-slate-500">${b.phoneNumber || '-'}</div>
                            </div>
                            <div>
                                <div class="text-[10px] font-black text-slate-400 uppercase mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Booking Details)</div>
                                <div class="text-sm font-bold">${b.date} | ${b.time}</div>
                                <div class="text-sm text-slate-500">${b.court} (${b.hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</div>
                                <div class="text-sm text-slate-500">‡πÑ‡∏ü‡πÄ‡∏õ‡∏¥‡∏î ${b.lightHours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
                            </div>
                        </div>
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-slate-500">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th class="px-4 py-2 text-right text-slate-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                    <th class="px-4 py-2 text-right text-slate-500">‡∏£‡∏ß‡∏°</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                <tr>
                                    <td class="px-4 py-3 font-medium">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏ô‡∏≤‡∏° (150/‡∏ä‡∏°.)</td>
                                    <td class="px-4 py-3 text-right">${b.hours} ‡∏ä‡∏°.</td>
                                    <td class="px-4 py-3 text-right">‡∏ø${(b.hours * 150).toLocaleString()}</td>
                                </tr>
                                ${b.lightHours > 0 ? `
                                <tr>
                                    <td class="px-4 py-3 font-medium">‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏™‡∏ô‡∏≤‡∏° (50/‡∏ä‡∏°.)</td>
                                    <td class="px-4 py-3 text-right">${b.lightHours} ‡∏ä‡∏°.</td>
                                    <td class="px-4 py-3 text-right">‡∏ø${(b.lightHours * 50).toLocaleString()}</td>
                                </tr>` : ''}
                            </tbody>
                            <tfoot class="border-t-2 border-slate-100">
                                <tr class="text-lg">
                                    <td colspan="2" class="px-4 py-4 font-black text-right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Total Amount):</td>
                                    <td class="px-4 py-4 font-black text-blue-700 text-right">‡∏ø${b.totalPrice.toLocaleString()}</td>
                                </tr>
                            </tfoot>
                        </table>
                        <div class="flex justify-between items-center pt-4">
                            <div class="text-[10px] text-slate-400">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ____________________</div>
                            <div class="text-[10px] text-slate-400">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: ${new Date().toLocaleString()}</div>
                        </div>
                    </div>
                `;

                container.innerHTML = `
                    <div class="w-full pb-8 border-b-2 border-dashed border-slate-200">
                        <div class="text-[10px] text-blue-500 font-bold mb-4 uppercase">Original Copy (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏•‡∏±‡∏ö)</div>
                        ${receiptHtml()}
                    </div>
                    <div class="w-full pt-8">
                        <div class="text-[10px] text-slate-400 font-bold mb-4 uppercase">Customer Copy (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</div>
                        ${receiptHtml()}
                    </div>
                `;
                document.getElementById('receiptModal').classList.add('modal-active');
            } catch (err) {
                console.error("Receipt Error:", err);
            }
        }

        window.viewSlip = (src) => {
            document.getElementById('slipPreview').src = src;
            document.getElementById('slipModal').classList.add('modal-active');
        }

        window.viewSlipFromId = (id) => {
            const src = window.slipCache[id];
            if(src) {
                window.viewSlip(src);
            }
        }

        window.closeModal = () => {
            document.querySelectorAll('.fixed').forEach(m => m.classList.remove('modal-active'));
        }

        window.deleteBooking = async (id) => {
            if(confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ?")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bookings', id));
                    renderAll();
                } catch (err) {
                    console.error("Delete Error:", err);
                    showAlert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
                }
            }
        }

        window.showAlert = (msg) => {
            const box = document.getElementById('customAlert');
            document.getElementById('alertMessage').innerText = msg;
            box.style.display = 'flex';
            setTimeout(() => box.style.display = 'none', 3000);
        }
    </script>
</body>
</html>
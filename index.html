<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Makmai Tennis Club - Booking System</title>
    <meta name="description" content="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏ï‡πÄ‡∏ó‡∏ô‡∏ô‡∏¥‡∏™‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏°‡∏Å‡πÑ‡∏°‡πâ">
    
    <!-- Libraries CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .glass-panel { background: #ffffff; border-radius: 1rem; box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.05); }
        .table-scroll { max-height: 450px; overflow-y: auto; }
        
        /* Flatpickr Customization */
        .flatpickr-calendar { font-family: 'Kanit', sans-serif; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: none; }
        .flatpickr-day.selected { background: #2563eb !important; border-color: #2563eb !important; }
        
        /* Fix: Ensure valid dates shown from next month are not greyed out */
        .flatpickr-day.nextMonthDay:not(.flatpickr-disabled), 
        .flatpickr-day.prevMonthDay:not(.flatpickr-disabled) {
            color: #1e293b !important;
            opacity: 1 !important;
        }
        
        /* --- PRINT STYLES --- */
        @media print {
            @page { 
                margin: 0; 
                size: auto;
            }
            body { 
                margin: 0; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                background-color: white;
            }
            body * { visibility: hidden; }
            .modal-active, .modal-active * { visibility: visible; }
            .modal-active {
                position: absolute; left: 0; top: 0; width: 100%; height: 100%; margin: 0; padding: 0;
                background-color: white !important; overflow: visible !important;
            }
            .modal-active .bg-white {
                width: 100% !important; max-width: none !important;
                box-shadow: none !important; border: none !important;
                padding: 0 !important;
            }
            .no-print, button, .fixed button { display: none !important; }
            #receiptContent { 
                /* Reduced padding for print to fit better */
                padding: 5mm !important; 
                width: 100%;
            }
            /* ‡∏ã‡πà‡∏≠‡∏ô Header/Footer ‡∏Ç‡∏≠‡∏á Browser */
            header, footer { display: none !important; }
        }

        .modal-active { display: flex !important; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        #customAlert { display: none; position: fixed; top: 20px; right: 20px; z-index: 9999; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .slot-free { background-color: #ecfdf5; color: #065f46; }
        .slot-booked { background-color: #ffedd5; color: #c2410c; }
        .slot-paid { background-color: #dbeafe; color: #1e40af; }
        .slot-past { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; }
        .slot-played { background-color: #FFFBEB; color: #92400E; border: 1px solid #FCD34D; }
        
        /* Highlight Animation */
        .slot-highlight {
            animation: pulse-ring 2s infinite;
        }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(251, 191, 36, 0); }
            100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Notification -->
    <div id="customAlert" class="bg-slate-800 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3">
        <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span id="alertMessage" class="font-bold"></span>
    </div>

    <!-- Hidden Input for Updating Slip -->
    <input type="file" id="updateSlipInput" class="hidden" accept="image/*">

    <div class="max-w-[1400px] mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6 no-print">
            <!-- Left Side: Title -->
            <div class="flex-1">
                <h1 class="text-3xl font-black text-slate-800 tracking-tight flex items-center gap-2">
                    <span class="bg-blue-600 text-white p-1 rounded">üéæ</span> ‡πÅ‡∏°‡∏Å‡πÑ‡∏°‡πâ‡πÄ‡∏ó‡∏ô‡∏ô‡∏¥‡∏™‡∏Ñ‡∏•‡∏±‡∏ö
                </h1>
                <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mt-1">Online Database System</p>
            </div>

            <!-- Center: Logo -->
            <div class="flex-shrink-0">
                <img src="‡πÅ‡∏°‡∏Å‡πÑ‡∏°‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏î‡∏≥.jpg" class="h-24 w-auto object-contain rounded-lg shadow-sm" alt="Makmai Logo">
            </div>

            <!-- Right Side: Action Button -->
            <div class="flex flex-1 justify-end gap-2">
                <button onclick="openReportModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm font-bold hover:bg-indigo-700 flex items-center gap-2 transition-all shadow-lg shadow-indigo-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Left: Booking Form -->
            <div class="lg:col-span-4 no-print">
                <div class="glass-panel p-6 border border-slate-200 sticky top-4" id="bookingPanel">
                    <h2 class="text-xl font-bold text-slate-700 mb-4">‡∏à‡∏≠‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏ï‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏ó‡∏ô‡∏ô‡∏¥‡∏™</h2>
                    <form id="bookingForm" class="space-y-4">
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-3">
                            <!-- Adjusted Grid for Date and Court -->
                            <div class="grid grid-cols-12 gap-3">
                                <div class="col-span-8 space-y-1">
                                    <label class="text-xs font-bold text-slate-500 uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                    <input type="text" id="dateInput" name="date" required class="w-full border border-slate-200 rounded-lg px-3 py-2 text-lg font-bold text-slate-700 bg-white cursor-pointer shadow-sm" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">
                                </div>
                                <div class="col-span-4 space-y-1">
                                    <label class="text-xs font-bold text-slate-500 uppercase">‡∏™‡∏ô‡∏≤‡∏°</label>
                                    <select name="court" class="w-full border border-slate-200 rounded-lg px-2 py-2.5 text-sm font-bold text-slate-700">
                                        <option value="‡∏™‡∏ô‡∏≤‡∏° 1">‡∏™‡∏ô‡∏≤‡∏° 1</option>
                                        <option value="‡∏™‡∏ô‡∏≤‡∏° 2">‡∏™‡∏ô‡∏≤‡∏° 2</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-12 gap-3">
                                <div class="col-span-6">
                                    <label class="text-xs font-bold text-slate-500 uppercase">‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                                    <select name="time" id="timeSelect" onchange="updateHourOptions()" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-lg font-bold text-slate-700"></select>
                                </div>
                                <div class="col-span-3">
                                    <label class="text-xs font-bold text-slate-500 uppercase">‡∏ä‡∏°.</label>
                                    <select name="hours" id="hoursSelect" onchange="updateLightHoursOptions()" class="w-full border border-slate-200 rounded-lg px-2 py-2.5 text-sm font-bold text-blue-600"></select>
                                </div>
                                <div class="col-span-3">
                                    <label class="text-xs font-bold text-slate-500 uppercase">‡πÑ‡∏ü</label>
                                    <select name="lightHours" id="lightHoursSelect" onchange="calculateTotal()" class="w-full border border-slate-200 rounded-lg px-2 py-2.5 text-sm font-bold text-amber-600"></select>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-bold text-slate-500 uppercase">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</span>
                                <select id="customerHistory" onchange="fillCustomerInfo(this.value)" class="text-xs text-blue-600 font-bold bg-transparent outline-none cursor-pointer">
                                    <option value="">‚ñº ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="inputName" name="customerName" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                <input type="tel" id="inputPhone" name="phoneNumber" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" maxlength="10" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm">
                            </div>
                            
                            <div class="flex items-center gap-2 w-full">
                                <div class="flex items-center shrink-0">
                                    <span class="text-sm text-slate-400 mr-1">125/</span>
                                    <input type="text" id="inputAddress" name="address" required placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" maxlength="3" class="w-16 border border-slate-200 rounded-lg px-2 py-2 text-sm text-center">
                                </div>
                                <div class="flex-1 min-w-0">
                                    <input type="text" id="inputOwner" name="ownerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm truncate">
                                </div>
                            </div>
                            
                            <div class="relative group">
                                <input type="file" id="slipInput" accept="image/*" class="hidden" onchange="updateFileName(this)">
                                <label for="slipInput" class="flex items-center justify-center gap-2 w-full px-4 py-2.5 bg-slate-100 text-slate-500 rounded-xl cursor-pointer hover:bg-slate-200 border border-slate-200 text-sm transition-all group-hover:border-blue-300 group-hover:text-blue-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                    <span id="slipFileName">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</span>
                                </label>
                            </div>
                        </div>

                        <div class="p-4 bg-slate-50 rounded-2xl flex justify-between items-center border-2 border-dashed border-blue-100">
                            <span class="text-xs font-bold text-slate-400 uppercase">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
                            <span id="totalPriceDisplay" class="text-2xl font-black text-blue-700">‡∏ø0</span>
                        </div>

                        <button id="submitBtn" type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-2xl shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2">
                            <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Right: Content -->
            <div class="lg:col-span-8 space-y-6">
                <!-- 1. Booking List -->
                <div class="glass-panel border border-slate-200 overflow-hidden no-print">
                    <div class="p-4 bg-white border-b flex justify-between items-center gap-4">
                        <h3 class="font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3>
                        <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-lg">
                            <button onclick="navigateWeek(-1)" class="p-2 hover:bg-white rounded-lg transition-colors" title="‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            </button>
                            <!-- Modified Week Display: Larger font size to match Date Input -->
                            <div id="weekDisplay" class="text-lg font-bold text-slate-700 min-w-[16rem] text-center select-none cursor-default">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                            <button onclick="navigateWeek(1)" class="p-2 hover:bg-white rounded-lg transition-colors" title="‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            </button>
                            <button onclick="goToCurrentWeek()" class="px-4 py-2 bg-white text-blue-600 rounded-lg text-sm font-black uppercase hover:bg-blue-600 hover:text-white transition-all shadow-sm">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</button>
                        </div>
                    </div>
                    <div class="table-scroll">
                        <table class="w-full text-left text-sm border-collapse">
                            <thead class="bg-slate-50 sticky top-0 text-[10px] uppercase font-bold text-slate-400">
                                <tr>
                                    <th class="px-4 py-3 text-center w-16">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th class="px-4 py-3">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="px-4 py-3">‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á / ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                    <th class="px-4 py-3">‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤ / ‡∏™‡∏ô‡∏≤‡∏°</th>
                                    <th class="px-4 py-3 text-right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                                    <th class="px-4 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="bookingTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- 2. Visual Schedule -->
                <div class="glass-panel p-5 border border-slate-200">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                        <div class="flex items-center gap-3">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2">
                                <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"></path></svg>
                                ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ô‡∏≤‡∏°
                            </h3>
                            <!-- Modified Date Picker: Larger size, font, and padding -->
                            <input type="text" id="scheduleDateInput" class="bg-slate-50 border border-slate-200 rounded-lg px-4 py-2 text-lg font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 w-48 text-center shadow-sm cursor-pointer" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">
                        </div>
                        <div class="flex gap-4 text-[10px] font-bold uppercase tracking-wider flex-wrap">
                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-emerald-400"></span> ‡∏ß‡πà‡∏≤‡∏á</span>
                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-orange-400"></span> ‡∏à‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</span>
                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-blue-500"></span> ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded" style="background-color: #FFFBEB; border: 1px solid #FCD34D;"></span> ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à/‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-slate-200"></span> ‡∏ú‡πà‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡πà‡∏ô</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-center border-collapse">
                            <thead>
                                <tr class="bg-slate-50 text-[11px] font-black text-slate-400 uppercase">
                                    <th class="p-2 border-b w-20">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                    <th class="p-2 border-b">‡∏™‡∏ô‡∏≤‡∏° 1</th>
                                    <th class="p-2 border-b">‡∏™‡∏ô‡∏≤‡∏° 2</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleGridBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Deletion -->
    <div id="confirmModal" class="fixed inset-0 bg-slate-900/80 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl text-center">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?</h3>
            <p class="text-slate-500 text-sm mb-6">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ</p>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" class="flex-1 px-4 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirmDeleteBtn" class="flex-1 px-4 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors shadow-lg shadow-red-200">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="fixed inset-0 bg-slate-900/90 z-[70] hidden items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white max-w-[210mm] w-full relative flex flex-col items-center p-0 md:p-8 rounded-none md:rounded-2xl">
            <button onclick="closeModal()" class="no-print absolute top-4 right-4 text-slate-400 hover:text-red-500 z-50">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div id="receiptContent" class="w-full space-y-8 bg-white"></div>
            <div id="receiptActions" class="no-print mt-8 flex gap-3 relative z-10 p-4">
                <button onclick="closeModal()" class="px-6 py-3 bg-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-300 transition-colors cursor-pointer">‡∏õ‡∏¥‡∏î</button>
                <button type="button" onclick="window.print()" class="px-10 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-colors cursor-pointer">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="fixed inset-0 bg-slate-900/90 z-50 hidden items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-3xl max-w-4xl w-full p-8 relative">
            <button onclick="closeModal()" class="no-print absolute top-6 right-6 text-slate-400 z-10 hover:text-slate-700"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <div id="reportSummaryContent" class="space-y-6"></div>
        </div>
    </div>

    <!-- Slip Preview Modal (Z-Index 60) -->
    <div id="slipModal" class="fixed inset-0 bg-black/95 z-[60] hidden flex-col items-center justify-center p-4 overflow-y-auto" onclick="if(event.target === this) closeModal()">
        <div class="max-w-2xl w-full flex flex-col items-center gap-4">
            <div class="relative w-full flex justify-center bg-black rounded-2xl overflow-hidden ring-1 ring-white/10">
                <img id="slipPreview" src="" class="max-h-[70vh] w-auto object-contain shadow-2xl">
            </div>
            <div class="no-print flex flex-wrap justify-center gap-3 w-full p-4 bg-white/10 backdrop-blur-md rounded-2xl border border-white/20 shadow-2xl relative z-10">
                <button onclick="closeModal()" class="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-bold transition-all flex items-center gap-2 shadow-lg active:scale-95 cursor-pointer">‡∏õ‡∏¥‡∏î‡∏†‡∏≤‡∏û</button>
                <button onclick="changeSlipInModal()" class="px-6 py-2.5 bg-amber-500 hover:bg-amber-400 text-white rounded-xl font-bold transition-all flex items-center gap-2 shadow-lg active:scale-95 cursor-pointer">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà</button>
                <button type="button" onclick="window.print()" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold transition-all flex items-center gap-2 shadow-lg active:scale-95 cursor-pointer">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏†‡∏≤‡∏û / PDF</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, onSnapshot, query } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        // Firebase Setup
        let firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyA4ACuJR2m49qx-I56bkO-VIiyMHbnXXSM",
            authDomain: "makmai-tennis-booking.firebaseapp.com",
            projectId: "makmai-tennis-booking",
            appId: "1:804008227066:web:3996d65a9a2585970cd943"
        };

        let app, auth, db, currentUser = null;
        const isCanvas = typeof __app_id !== 'undefined';
        const appId = isCanvas ? __app_id : 'makmai-tennis-online'; 

        let currentFilterWeek = '', currentUploadId = null, allBookingsCache = [], itemToDeleteId = null, currentViewingSlipId = null; 
        let revenueChart = null, housesChart = null;
        let highlightedBookingId = null; 
        let unsubscribe = null; // Track listener to prevent duplicates
        window.slipCache = {};

        const thaiMonths = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];

        const initAuth = async () => {
            try {
                app = initializeApp(firebaseConfigRaw);
                auth = getAuth(app);
                db = getFirestore(app);
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else { await signInAnonymously(auth); }
                onAuthStateChanged(auth, (user) => { if (user) { currentUser = user; init(); setupRealtimeListener(); } });
            } catch (error) { console.error("Firebase Auth Error:", error); }
        };

        function getBookingsCollection() {
            return isCanvas ? collection(db, 'artifacts', appId, 'public', 'data', 'bookings') : collection(db, 'bookings');
        }

        function setupRealtimeListener() {
            // Unsubscribe existing listener if any to prevent duplicates
            if (unsubscribe) {
                unsubscribe();
            }
            const q = query(getBookingsCollection());
            unsubscribe = onSnapshot(q, (snapshot) => {
                allBookingsCache = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                renderAll(); loadCustomerHistory();
            });
        }

        // --- Date Helpers (Strict Thailand Timezone) ---
        function getThailandNow() {
            const now = new Date();
            // Convert to Thailand Time (UTC+7)
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            return new Date(utc + (7 * 3600000));
        }

        function getThailandDate() {
            return getThailandNow().toISOString().split('T')[0];
        }

        function getThailandHour() {
            return getThailandNow().getHours();
        }

        function parseLocalDate(dateStr) {
            if (dateStr instanceof Date) return new Date(dateStr);
            if (!dateStr) return new Date();
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        function getNextSundayDate() {
            const d = getThailandNow();
            const day = d.getDay();
            const daysToTarget = (day === 0) ? 14 : (7 - day + 7);
            const targetSunday = new Date(d);
            targetSunday.setDate(d.getDate() + daysToTarget);
            return targetSunday.toISOString().split('T')[0];
        }

        function getWeekString(dateInput) {
            const d = parseLocalDate(dateInput);
            d.setHours(0,0,0,0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const year = d.getFullYear();
            const week = Math.ceil((((d - new Date(year, 0, 1)) / 86400000) + 1) / 7);
            return `${year}-W${String(week).padStart(2, '0')}`;
        }

        function getStartOfWeek(weekStr) {
             const [y, w] = weekStr.split('-W').map(Number);
             const d = new Date(y, 0, 4); 
             const day = d.getDay() || 7;
             d.setDate(d.getDate() - day + 1 + ((w - 1) * 7));
             d.setHours(0,0,0,0);
             return d;
        }

        function formatThaiDate(dateInput) {
            if (!dateInput) return "-";
            let d;
            if (typeof dateInput === 'string') {
                const [y, m, day] = dateInput.split('-').map(Number);
                d = new Date(y, m - 1, day);
            } else if (dateInput instanceof Date) {
                d = dateInput;
            } else {
                return dateInput;
            }
            if (isNaN(d.getTime())) return dateInput;
            const day = d.getDate();
            const month = thaiMonths[d.getMonth()];
            const year = d.getFullYear();
            return `${day} ${month} ${year}`;
        }

        function updateWeekLabel() {
            const d = getStartOfWeek(currentFilterWeek);
            const display = document.getElementById('weekDisplay');
            if (display) display.innerText = `‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏µ‡πà: ${formatThaiDate(d)}`;
        }

        function generateRef(b) {
            const dateStr = b.date || "";
            const [y, m, d] = dateStr.split('-');
            const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
            const courtCode = (b.court || "").includes('1') ? 'C-1' : 'C-2';
            const start = parseInt(b.time) || 0;
            return `${courtCode}/${start}-${start + (Number(b.hours) || 0)}/${d || "00"}-${months[parseInt(m) - 1] || "XX"}-${(y || "").slice(-2)}`;
        }

        function init() {
            const todayStr = getThailandDate();
            const maxDate = getNextSundayDate();
            
            flatpickr("#dateInput", {
                locale: 'th', altInput: true, altFormat: "d/M/Y", dateFormat: "Y-m-d", 
                minDate: todayStr, maxDate: maxDate, defaultDate: todayStr,
                onChange: (sd, dateStr) => { 
                    document.getElementById('scheduleDateInput')._flatpickr.setDate(dateStr);
                    syncDateToSchedule();
                }
            });
            
            flatpickr("#scheduleDateInput", {
                locale: 'th', altInput: true, altFormat: "d/M/Y", dateFormat: "Y-m-d", 
                defaultDate: todayStr,
                onChange: (sd, dateStr) => {
                    currentFilterWeek = getWeekString(dateStr);
                    updateWeekLabel();
                    renderAll();
                }
            });
            
            const timeSelect = document.getElementById('timeSelect');
            let timeHtml = '';
            for(let i=7; i<=21; i++) timeHtml += `<option value="${String(i).padStart(2,'0')}:00">${i}:00 ‡∏ô.</option>`;
            timeSelect.innerHTML = timeHtml;

            // Set default time to current hour
            const nowH = getThailandHour();
            if(nowH >= 7 && nowH <= 21) {
                timeSelect.value = String(nowH).padStart(2, '0') + ":00";
            }

            updateHourOptions(); 
            goToCurrentWeek();
        }

        window.updateHourOptions = () => {
            const start = parseInt(document.getElementById('timeSelect').value);
            let html = '';
            for(let i=1; i<=Math.min(4, 22-start); i++) html += `<option value="${i}">${i}</option>`;
            document.getElementById('hoursSelect').innerHTML = html;
            window.updateLightHoursOptions();
        }

        window.updateLightHoursOptions = () => {
            const hrs = parseInt(document.getElementById('hoursSelect').value);
            let html = '<option value="0">‡∏õ‡∏¥‡∏î</option>';
            for(let i=1; i<=hrs; i++) html += `<option value="${i}">${i} ‡∏ä‡∏°.</option>`;
            document.getElementById('lightHoursSelect').innerHTML = html;
            window.calculateTotal();
        }

        window.calculateTotal = () => {
            const h = parseInt(document.getElementById('hoursSelect').value) || 0;
            const l = parseInt(document.getElementById('lightHoursSelect').value) || 0;
            const total = (h * 150) + (l * 50);
            document.getElementById('totalPriceDisplay').innerText = `‡∏ø${total.toLocaleString()}`;
        }

        window.updateFileName = (input) => {
            const span = document.getElementById('slipFileName');
            span.innerText = input.files[0] ? input.files[0].name : '‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô';
            if(input.files[0]) span.classList.add('text-blue-600', 'font-bold');
        }

        window.syncDateToSchedule = () => {
            const formDate = document.getElementById('dateInput').value;
            currentFilterWeek = getWeekString(formDate);
            updateWeekLabel();
            renderAll();
        }

        window.goToCurrentWeek = () => {
            const dateStr = getThailandDate();
            currentFilterWeek = getWeekString(dateStr);
            updateWeekLabel();
            const gridPicker = document.getElementById('scheduleDateInput');
            if (gridPicker && gridPicker._flatpickr) gridPicker._flatpickr.setDate(dateStr);
            renderAll();
        }

        window.navigateWeek = (dir) => {
            const d = getStartOfWeek(currentFilterWeek);
            d.setDate(d.getDate() + (dir * 7));
            currentFilterWeek = getWeekString(d);
            updateWeekLabel();
            const gridPicker = document.getElementById('scheduleDateInput');
            if (gridPicker && gridPicker._flatpickr) {
                gridPicker._flatpickr.setDate(d);
            }
            renderAll();
        }

        function renderAll() { renderBookingList(); renderSchedule(); }

        window.selectBookingFromList = (b) => {
            highlightedBookingId = b.id;
            const gridPicker = document.getElementById('scheduleDateInput');
            if(gridPicker && gridPicker._flatpickr) {
                gridPicker._flatpickr.setDate(b.date);
            }
            renderSchedule();
            
            const schedulePanel = document.getElementById('scheduleGridBody').closest('.glass-panel');
            if(schedulePanel) {
                schedulePanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        };

        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const MAX = 600;
                        let w = img.width, h = img.height;
                        if (w > h) { if (w > MAX) { h *= MAX / w; w = MAX; } } 
                        else { if (h > MAX) { w *= MAX / h; h = MAX; } }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
            });
        };

        document.getElementById('bookingForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn'); 
            const fd = new FormData(e.target);
            const date = fd.get('date');
            const startH = parseInt(fd.get('time').split(':')[0]);
            const hours = parseInt(fd.get('hours'));
            const lightHours = parseInt(fd.get('lightHours'));
            
            // Logic Check: No past bookings (Allow current hour booking)
            const nowThai = getThailandNow();
            const todayThaiStr = getThailandDate();
            // Changed <= to < to allow booking in the current hour
            if (date < todayThaiStr || (date === todayThaiStr && startH < nowThai.getHours())) {
                window.showAlert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà");
                return;
            }

            btn.disabled = true; btn.innerHTML = '<span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>';

            const requested = Array.from({length: hours}, (_, i) => startH + i);
            const conflict = allBookingsCache.filter(b => b.date === date && b.court === fd.get('court')).some(b => {
                const bS = parseInt(b.time.split(':')[0]);
                return requested.some(s => s >= bS && s < bS + b.hours);
            });
            if (conflict) { window.showAlert("‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß!"); btn.disabled = false; btn.innerHTML = '<span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</span>'; return; }
            
            const file = document.getElementById('slipInput').files[0];
            const slip = file ? await compressImage(file) : null;
            
            const data = {
                date, court: fd.get('court'), time: fd.get('time'), 
                hours: Number(hours), 
                lightHours: Number(lightHours),
                customerName: fd.get('customerName'), phoneNumber: fd.get('phoneNumber'),
                address: fd.get('address'), ownerName: fd.get('ownerName'),
                totalPrice: (hours * 150) + (lightHours * 50),
                timestamp: Date.now(), week: getWeekString(date), slip
            };
            
            try {
                await addDoc(getBookingsCollection(), data);
                e.target.reset(); window.updateFileName({files:[]});
                window.showAlert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                // Reset to today after submission
                init();
            } catch (err) {
                window.showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
            } finally {
                btn.disabled = false; btn.innerHTML = '<span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</span>';
            }
        };

        window.renderSchedule = () => {
            const date = document.getElementById('scheduleDateInput').value;
            if (!date) return;
            const today = getThailandDate(); 
            const nowH = getThailandHour();
            const tbody = document.getElementById('scheduleGridBody'); tbody.innerHTML = '';
            const filtered = allBookingsCache.filter(b => b.date === date);
            
            for(let h=7; h<=21; h++) {
                const tr = document.createElement('tr');
                // Updated Past Logic: Check both date and hour. Changed <= to < to allow current hour.
                const isPast = (date < today) || (date === today && h < nowH);
                
                tr.innerHTML = `<td class="p-2 border-b font-mono text-slate-400">${h}:00</td>`;
                ["‡∏™‡∏ô‡∏≤‡∏° 1", "‡∏™‡∏ô‡∏≤‡∏° 2"].forEach(court => {
                    const b = filtered.find(b => { const bS = parseInt(b.time); return b.court === court && h >= bS && h < bS + b.hours; });
                    const td = document.createElement('td'); td.className = "p-1 border border-slate-100";
                    
                    // Highlight logic
                    let extraClass = '';
                    if (b && b.id === highlightedBookingId) {
                        extraClass = 'ring-2 ring-offset-1 ring-amber-400 shadow-md scale-105 z-10 relative';
                    }

                    if(b) {
                        td.innerHTML = `<div class="rounded py-1 text-[10px] font-bold ${b.slip ? (date < today || (date===today && parseInt(b.time)<=nowH) ? 'slot-played' : 'slot-paid') : 'slot-booked'} ${extraClass}">${b.customerName}</div>`;
                    } else if(isPast) {
                        td.innerHTML = `<div class="rounded py-1 text-[10px] slot-past">‚úï</div>`;
                    } else {
                        td.innerHTML = `<div onclick="selectSlot('${date}', '${h}:00', '${court}')" class="rounded py-1 text-[10px] slot-free cursor-pointer hover:bg-emerald-200">‡∏ß‡πà‡∏≤‡∏á</div>`;
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            }
        };

        window.selectSlot = (d, t, c) => {
            const today = getThailandDate();
            const nowH = getThailandHour();
            const h = parseInt(t.split(':')[0]);
            
            // Final safety check for click in grid. Changed <= to <
            if (d < today || (d === today && h < nowH)) {
                window.showAlert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ");
                return;
            }

            document.getElementById('dateInput')._flatpickr.setDate(d);
            document.querySelector('select[name="court"]').value = c;
            document.getElementById('timeSelect').value = t.padStart(5, '0');
            updateHourOptions();
            document.getElementById('bookingPanel').scrollIntoView({ behavior: 'smooth' });
        };

        function renderBookingList() {
            const tbody = document.getElementById('bookingTableBody'); 
            tbody.innerHTML = '';
            
            // Filter by week
            let list = allBookingsCache.filter(b => b.week === currentFilterWeek);

            if (!list.length) { 
                tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</td></tr>`; 
                return; 
            }

            // Group by Date
            const groups = list.reduce((groups, booking) => {
                const date = booking.date;
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(booking);
                return groups;
            }, {});

            // Sort Dates
            const sortedDates = Object.keys(groups).sort();
            const today = getThailandDate();

            let sequenceNumber = 1;

            sortedDates.forEach(date => {
                const bookings = groups[date];
                // Sort bookings within the day: Time -> Court
                bookings.sort((a, b) => {
                    const timeA = a.time || "";
                    const timeB = b.time || "";
                    if (timeA !== timeB) return timeA.localeCompare(timeB);
                    const courtA = a.court || "";
                    const courtB = b.court || "";
                    return courtA.localeCompare(courtB);
                });

                // Determine Color
                // Past = Gray (slate-300/400), Today/Future = Green (emerald-400/500)
                const isPast = date < today;
                const borderColor = isPast ? 'border-slate-300' : 'border-emerald-500';
                const bgColor = isPast ? 'bg-slate-50' : 'bg-white';

                // Spacer Row (if not first group)
                if (tbody.children.length > 0) {
                     const spacer = document.createElement('tr');
                     spacer.innerHTML = '<td colspan="6" class="h-4 border-none bg-transparent"></td>';
                     tbody.appendChild(spacer);
                }

                bookings.forEach((b, index) => {
                    if (b.slip) window.slipCache[b.id] = b.slip;
                    const tr = document.createElement('tr');
                    
                    let classes = `hover:bg-slate-50 cursor-pointer transition-colors relative `;
                    classes += `border-l-4 border-r-4 ${borderColor} ${bgColor} `;
                    
                    if (index === 0) {
                        classes += `border-t-4 `;
                    }
                    if (index === bookings.length - 1) {
                        classes += `border-b-4 `;
                    } else {
                        classes += `border-b border-slate-100 `; 
                    }

                    tr.className = classes;

                    tr.onclick = (e) => {
                        if(e.target.closest('button') || e.target.closest('input')) return;
                        selectBookingFromList(b);
                    };

                    tr.innerHTML = `
                        <td class="px-4 py-3 text-center font-bold text-slate-500 border-none">${sequenceNumber++}</td>
                        <td class="px-4 py-3 border-none"><div class="text-[10px] font-bold text-slate-400 font-mono">${generateRef(b)}</div><span class="px-2 py-0.5 rounded-full text-[10px] font-black ${b.slip ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'}">${b.slip ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞'}</span></td>
                        <td class="px-4 py-3 border-none"><div class="font-bold text-slate-700">${b.customerName}</div><div class="text-[11px] text-slate-400">125/${b.address}</div></td>
                        <td class="px-4 py-3 border-none"><div class="font-bold text-blue-600">${formatThaiDate(b.date)}</div><div class="text-[11px] font-bold text-slate-500">${b.time} (${b.hours} ‡∏ä‡∏°.) - ${b.court}</div></td>
                        <td class="px-4 py-3 text-right font-black text-slate-700 border-none">‡∏ø${(Number(b.totalPrice) || 0).toLocaleString()}</td>
                        <td class="px-4 py-3 border-none"><div class="flex justify-center gap-1">
                            <button onclick="${b.slip ? `printReceipt('${b.id}')` : ''}" class="p-2 rounded-lg transition-colors ${b.slip ? 'text-blue-600 hover:bg-blue-50' : 'text-slate-300'}" ${!b.slip ? 'disabled' : ''}>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                            </button>
                            ${b.slip ? `<button onclick="viewSlipFromId('${b.id}')" class="p-2 text-emerald-600 hover:bg-emerald-50 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></button>` :
                            `<button onclick="window.triggerUploadSlip('${b.id}')" class="p-2 text-slate-400 hover:text-blue-600 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg></button>`}
                            <button onclick="deleteBooking('${b.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div></td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        window.printReceipt = async (id) => {
            try {
                const b = allBookingsCache.find(d => d.id === id); 
                if (!b) {
                    window.showAlert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á");
                    return;
                }
                
                const hrs = Number(b.hours || 0);
                const lHrs = Number(b.lightHours || 0);
                const cFee = hrs * 150;
                const lFee = lHrs * 50;
                const total = Number(b.totalPrice || (cFee + lFee));

                // Compact Receipt HTML - Removed mb-4 to control spacing via separator
                const receiptHtml = (type) => `
                    <div class="border border-slate-800 p-4 rounded-none relative bg-white" style="page-break-inside: avoid;">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-start gap-2">
                                <img src="‡πÅ‡∏°‡∏Å‡πÑ‡∏°‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏î‡∏≥.jpg" class="w-12 h-12 object-contain" alt="Logo">
                                <div>
                                    <h2 class="text-lg font-black text-slate-800 tracking-tight leading-tight">MAKMAI TENNIS CLUB</h2>
                                    <p class="text-[10px] uppercase font-bold text-slate-500">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / Receipt</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-0.5">${type === 'copy' ? '‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£' : '‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö'}</div>
                                <div class="font-mono text-sm font-bold text-slate-700">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: #${generateRef(b)}</div>
                                <div class="text-[10px] font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatThaiDate(getThailandNow())}</div>
                            </div>
                        </div>
                        
                        <div class="border-t border-slate-800 py-2 my-2">
                            <div class="mb-2">
                                <h3 class="text-[10px] font-bold text-slate-800 uppercase border-b border-slate-300 pb-0.5 mb-1">‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ / Customer</h3>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <div><span class="text-slate-500 mr-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</span> <span class="font-bold">${b.customerName}</span></div>
                                    <div><span class="text-slate-500 mr-1">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</span> <span class="font-bold">125/${b.address}</span></div>
                                    <div><span class="text-slate-500 mr-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á:</span> <span class="font-bold">${b.ownerName || '-'}</span></div>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-[10px] font-bold text-slate-800 uppercase border-b border-slate-300 pb-0.5 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á / Booking</h3>
                                <div class="grid grid-cols-3 gap-2 text-xs">
                                    <div><span class="text-slate-500 mr-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏≤‡∏°:</span> <span class="font-bold">${b.court}</span></div>
                                    <div><span class="text-slate-500 mr-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°:</span> <span class="font-bold">${b.time} ‡∏ô.</span></div>
                                    <div><span class="text-slate-500 mr-1">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô:</span> <span class="font-bold">${b.hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span></div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-1 border-t border-slate-800 pt-2">
                            <div class="flex justify-between text-xs items-center">
                                <span class="text-slate-600 font-medium">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏ô‡∏≤‡∏° (${hrs} ‡∏ä‡∏°. x ‡∏ø150)</span>
                                <span class="font-mono font-bold text-slate-700">‡∏ø${cFee.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between text-xs items-center">
                                <span class="text-slate-600 font-medium">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏° (${lHrs} ‡∏ä‡∏°. x ‡∏ø50)</span>
                                <span class="font-mono font-bold text-slate-700">‡∏ø${lFee.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center mt-1 pt-1 border-t border-slate-300">
                                <span class="text-sm font-black uppercase tracking-wider text-slate-800">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô / Total</span>
                                <span class="text-xl font-black text-slate-900 font-mono">‡∏ø${total.toLocaleString()}</span>
                            </div>
                        </div>

                        <div class="flex justify-end pt-12 mt-4">
                            <div class="text-center w-32">
                                <div class="border-b border-slate-400 mb-1 h-8"></div>
                                <span class="text-[8px] font-bold text-slate-500 uppercase tracking-widest">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / Recipient</span>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('receiptContent').innerHTML = `
                    <div class="flex flex-col w-full">
                        ${receiptHtml('copy')}
                        
                        <div class="w-full py-8 relative flex items-center justify-center print:py-10">
                            <div class="absolute w-full border-b-2 border-dashed border-slate-400 top-1/2"></div>
                            <span class="relative bg-white px-4 text-[10px] text-slate-500 font-mono uppercase tracking-widest z-10 flex items-center gap-2">
                                ‚úÇ ‡∏ï‡∏±‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏≠‡∏¢‡∏õ‡∏£‡∏∞ / CUT HERE
                            </span>
                        </div>

                        ${receiptHtml('original')}
                    </div>
                `;
                
                document.getElementById('receiptModal').classList.add('modal-active');
                setTimeout(() => window.print(), 500);
            } catch(e) {
                console.error(e);
                window.showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à");
            }
        }

        window.deleteBooking = (id) => { itemToDeleteId = id; document.getElementById('confirmModal').classList.add('modal-active'); };
        window.closeConfirmModal = () => { document.getElementById('confirmModal').classList.remove('modal-active'); itemToDeleteId = null; };
        document.getElementById('confirmDeleteBtn').onclick = async () => {
            if (!itemToDeleteId) return;
            try {
                const docRef = isCanvas ? doc(db, 'artifacts', appId, 'public', 'data', 'bookings', itemToDeleteId) : doc(db, 'bookings', itemToDeleteId);
                await deleteDoc(docRef); window.showAlert("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"); closeConfirmModal();
            } catch (err) { window.showAlert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ"); }
        };

        window.openReportModal = () => {
            const list = allBookingsCache; 
            const today = getThailandDate();
            const curM = today.slice(0, 7); 
            const curY = today.slice(0, 4);
            const mTotal = list.filter(b => b.date && b.date.startsWith(curM)).reduce((s, b) => s + (Number(b.totalPrice) || 0), 0);
            const yTotal = list.filter(b => b.date && b.date.startsWith(curY)).reduce((s, b) => s + (Number(b.totalPrice) || 0), 0);
            const content = document.getElementById('reportSummaryContent');
            
            content.innerHTML = `
                <div class="text-center mb-6"><h2 class="text-2xl font-black text-slate-800">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2><p class="text-slate-400 text-xs font-bold uppercase tracking-widest mt-1">Makmai Tennis Club Dashboard</p></div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-6 rounded-2xl text-center border border-blue-100 shadow-sm"><div class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-1">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div><div class="text-3xl font-black text-blue-700">‡∏ø${mTotal.toLocaleString()}</div></div>
                    <div class="bg-indigo-50 p-6 rounded-2xl text-center border border-indigo-100 shadow-sm"><div class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-1">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏õ‡∏µ‡∏ô‡∏µ‡πâ (${curY})</div><div class="text-3xl font-black text-indigo-700">‡∏ø${yTotal.toLocaleString()}</div></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm"><h3 class="text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-wider">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3><canvas id="revenueChart"></canvas></div>
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm"><h3 class="text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-wider">5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏≠‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á)</h3><canvas id="housesChart"></canvas></div>
                </div>
                <div class="pt-6 no-print grid grid-cols-2 gap-4">
                    <button onclick="closeModal()" class="w-full bg-slate-200 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-300">‡∏õ‡∏¥‡∏î</button>
                    <button onclick="window.print()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô / PDF</button>
                </div>
            `;
            document.getElementById('reportModal').classList.add('modal-active');
            setTimeout(() => { renderCharts(list, parseInt(curY)); }, 100);
        }

        window.renderCharts = (bookings, year) => {
            const monthlyRevenue = new Array(12).fill(0);
            bookings.forEach(b => { 
                if(b.date && b.date.startsWith(year)) {
                    const m = parseInt(b.date.split('-')[1]) - 1;
                    monthlyRevenue[m] += (Number(b.totalPrice) || 0);
                }
            });

            const houseCounts = {};
            bookings.forEach(b => { 
                const addressPart = b.address || '-';
                const ownerPart = b.ownerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const label = `125/${addressPart} (${ownerPart})`;
                houseCounts[label] = (houseCounts[label] || 0) + 1; 
            });
            const sortedH = Object.entries(houseCounts).sort(([,a], [,b]) => b - a).slice(0, 5);

            if(revenueChart) revenueChart.destroy(); if(housesChart) housesChart.destroy();
            
            revenueChart = new Chart(document.getElementById('revenueChart'), {
                type: 'bar', 
                data: { labels: ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'], datasets: [{ label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)', data: monthlyRevenue, backgroundColor: '#3b82f6', borderRadius: 4 }] },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            housesChart = new Chart(document.getElementById('housesChart'), {
                type: 'doughnut', 
                data: { labels: sortedH.map(([h]) => h), datasets: [{ data: sortedH.map(([,c]) => c), backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }] },
                options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9, family: 'Kanit' } } } } }
            });
        }

        window.triggerUploadSlip = (id) => { currentUploadId = id; document.getElementById('updateSlipInput').click(); }
        document.getElementById('updateSlipInput').onchange = async (e) => {
            const file = e.target.files[0]; if (!file || !currentUploadId) return;
            try {
                const slip = await compressImage(file);
                const docRef = isCanvas ? doc(db, 'artifacts', appId, 'public', 'data', 'bookings', currentUploadId) : doc(db, 'bookings', currentUploadId);
                await updateDoc(docRef, { slip }); window.showAlert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                if (document.getElementById('slipModal').classList.contains('modal-active') && currentViewingSlipId === currentUploadId) document.getElementById('slipPreview').src = slip;
            } catch (err) { window.showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î"); } finally { e.target.value = ''; currentUploadId = null; }
        }

        window.viewSlipFromId = (id) => { if(window.slipCache[id]) { currentViewingSlipId = id; document.getElementById('slipPreview').src = window.slipCache[id]; document.getElementById('slipModal').classList.add('modal-active'); } }
        window.changeSlipInModal = () => { if (!currentViewingSlipId) return; currentUploadId = currentViewingSlipId; document.getElementById('updateSlipInput').click(); }
        window.closeModal = () => { document.querySelectorAll('.fixed').forEach(m => m.classList.remove('modal-active')); }
        window.closeConfirmModal = () => { document.getElementById('confirmModal').classList.remove('modal-active'); }
        window.showAlert = (msg) => { const box = document.getElementById('customAlert'); box.querySelector('span').innerText = msg; box.style.display = 'flex'; setTimeout(() => box.style.display = 'none', 3000); }
        window.fillCustomerInfo = (json) => {
            if(!json) return; const c = JSON.parse(json);
            document.getElementById('inputName').value = c.name; document.getElementById('inputPhone').value = c.phone || '';
            document.getElementById('inputAddress').value = c.address || ''; document.getElementById('inputOwner').value = c.owner || '';
        }
        async function loadCustomerHistory() {
            const s = document.getElementById('customerHistory'); if (!s) return; s.innerHTML = '<option value="">‚ñº ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°</option>';
            const unique = new Map();
            allBookingsCache.forEach(d => { if (d.customerName && !unique.has(d.customerName)) unique.set(d.customerName, { name: d.customerName, phone: d.phoneNumber, address: d.address, owner: d.ownerName }); });
            unique.forEach(c => { const opt = document.createElement('option'); opt.value = JSON.stringify(c); opt.textContent = c.name; s.appendChild(opt); });
        }

        initAuth();
    </script>
</body>
</html>